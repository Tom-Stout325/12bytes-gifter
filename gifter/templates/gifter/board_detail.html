{% extends "index.html" %}
{% load static %}

{% block title %}{{ post.title }} | Message Board | Gifter{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 800px;">

  <a href="{% url 'gifter:board_list' %}" class="btn btn-link btn-sm px-0 mb-3">
    ‚Üê Back to Message Board
  </a>

  <!-- Post card -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start gap-2 mb-2 flex-wrap">
        <h2 class="h4 mb-0">{{ post.title }}</h2>

        {% if can_edit_post %}
          <div class="d-flex flex-wrap gap-2">
            <a href="{% url 'gifter:board_update' pk=post.pk %}"
               class="btn btn-sm btn-outline-secondary">
              <i class="fa-solid fa-pen-to-square me-1"></i> Edit
            </a>
            <a href="{% url 'gifter:board_delete' pk=post.pk %}"
               class="btn btn-sm btn-outline-danger">
              <i class="fa-solid fa-trash-can me-1"></i> Delete
            </a>
          </div>
        {% endif %}
      </div>

      <div class="small text-muted mb-3">
        Posted by
        <strong>{{ post.author.get_full_name|default:post.author.username }}</strong>
        on {{ post.created_at|date:"M j, Y g:i a" }}
      </div>

      <div class="mb-2" style="white-space:pre-wrap;">
        {{ post.body }}
      </div>
    </div>
  </div>

  <!-- Comments -->
  <div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Comments</span>
      <span class="badge bg-light text-dark border">
        {{ comments|length }} comment{{ comments|length|pluralize }}
      </span>
    </div>
    <div class="card-body">
      {% if comments %}
        <ul class="list-unstyled mb-4">
          {% for comment in comments %}
            <li class="mb-3 pb-3 border-bottom">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="small fw-semibold">
                    {{ comment.author.get_full_name|default:comment.author.username }}
                  </div>
                  <div class="small text-muted mb-1">
                    {{ comment.created_at|date:"M j, Y g:i a" }}
                  </div>
                </div>
                {% if request.user == comment.author or request.user.is_staff %}
                    <div class="d-flex flex-wrap gap-2">
                        <a href="{% url 'gifter:board_comment_update' pk=comment.pk %}"
                        class="btn btn-sm btn-outline-secondary">
                        Edit
                        </a>
                        <form method="post"
                            action="{% url 'gifter:board_comment_delete' pk=comment.pk %}"
                            onsubmit="return confirm('Delete this comment?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                        </button>
                        </form>
                    </div>
                    {% endif %}
              </div>
              <div class="mt-2" style="white-space:pre-wrap;">
                {{ comment.body }}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted small">No comments yet. Start the conversation!</p>
      {% endif %}

      <!-- Add comment form -->
      <form method="post" action="{% url 'gifter:board_comment_create' post_id=post.pk %}">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">Add a comment</label>
          {{ comment_form.body }}
          {{ comment_form.body.errors }}
        </div>
        <button type="submit" class="btn btn-primary btn-sm">
          Post Comment
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %}
