{% extends "index.html" %}
{% load static %}

{% block title %}
<!-- DEBUG: PROFILE FORM TEMPLATE - ACCOUNTS APP -->

  {% if setup_mode %}Set Up Profile | Gifter{% else %}Edit Profile | Gifter{% endif %}
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 700px;">
  <h2 class="text-secondary mb-3 text-center">
    {% if setup_mode %}Set Up Your Profile{% else %}Edit Your Profile{% endif %}
  </h2>
  <p class="text-muted text-center mb-4">
    {% if setup_mode %}
      Add your info and avatar so your family can pick the perfect gifts for you.
    {% else %}
      Update your info and avatar so your family can pick the perfect gifts for you.
    {% endif %}
  </p>

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}
    {{ form.non_field_errors }}
    <!-- === USER INFO CARD === -->
    <div class="card mb-4">
      <div class="card-header fw-semibold">Your Account</div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">First Name</label>
            {{ form.first_name }} {{ form.first_name.errors }}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Last Name</label>
            {{ form.last_name }} {{ form.last_name.errors }}
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Username <span class="text-danger">*</span></label>
          {{ form.username }} {{ form.username.errors }}
        </div>
        <div class="mb-3">
          <label class="form-label">Email Address</label>
          {{ form.email }} {{ form.email.errors }}
          <div class="form-text text-muted">Used for login and notifications.</div>
        </div>
      </div>
    </div>

    <!-- === HOUSEHOLD === -->
    <div class="card mb-4">
      <div class="card-header fw-semibold">Household</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Family / Household</label>
          {{ form.family }} {{ form.family.errors }}
        </div>
        <div class="mb-0">
          <label class="form-label">Role</label>
          {{ form.role }} {{ form.role.errors }}
          <div class="form-text">Parents can manage family profiles.</div>
        </div>
      </div>
    </div>
<!-- Personal Info -->
<div class="card mb-4">
  <div class="card-header fw-semibold">Personal Info</div>
  <div class="card-body">
    <div class="row">
      <div class="col-sm-6 mb-3">
        <label class="form-label">Birthday</label>
        {{ form.birthday }} {{ form.birthday.errors }}
      </div>
      <div class="col-sm-6 mb-3">
        <label class="form-label">Anniversary (optional)</label>
        {{ form.anniversary }} {{ form.anniversary.errors }}
      </div>
    </div>
    <div class="row">
      <div class="col-sm-4 mb-3">
        <label class="form-label">Shirt Size</label>
        {{ form.shirt_size }}
      </div>
      <div class="col-sm-4 mb-3">
        <label class="form-label">Pants Size</label>
        {{ form.pants_size }}
      </div>
      <div class="col-sm-4 mb-3">
        <label class="form-label">Shoe Size</label>
        {{ form.shoe_size }}
      </div>
    </div>
  </div>
</div>

<!-- Favorites & Notes -->
<div class="card mb-4">
  <div class="card-header fw-semibold">Favorites & Notes</div>
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Hobbies / Sports / Interests</label>
      {{ form.hobbies_sports }}
    </div>
    <div class="mb-3">
      <label class="form-label">Favorite Stores</label>
      {{ form.favorite_stores }}
    </div>
    <div class="mb-3">
      <label class="form-label">Favorite Websites</label>
      {{ form.favorite_websites }}
    </div>
    {% if form.fields.private_notes %}
    <div class="mb-3">
      <label class="form-label">Private Notes (Parent only)</label>
      {{ form.private_notes }}
      <div class="form-text text-muted">Only visible to Parent users.</div>
    </div>
    {% endif %}
  </div>
</div>

    <!-- === AVATAR CARD (New UI) === -->
    <div class="card mb-4">
      <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
        <span>Current Avatar</span>
        <a href="#" id="resetToDefaultLink" class="small text-decoration-none">Reset to default</a>
      </div>

      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
          <div class="d-flex align-items-center">
            <img id="activeAvatarPreviewImg"
                 src="{{ form.instance.get_avatar_url }}"
                 alt="Current avatar"
                 class="rounded-circle border me-3"
                 style="width:60px;height:60px;object-fit:cover;">
            <span class="badge bg-light text-dark border">
              {% if form.instance.avatar_source == "library" %}Gallery
              {% elif form.instance.avatar_source == "upload" %}Upload
              {% else %}Default
              {% endif %}
            </span>
          </div>

          <button type="button"
                  class="btn btn-primary btn-sm"
                  data-bs-toggle="modal"
                  data-bs-target="#avatarPickerModal">
            Change avatar
          </button>
        </div>

        <div class="text-muted small mb-2">This is how you'll appear</div>

        <!-- Hidden field for library filename -->
        {{ form.avatar_library_filename }} {{ form.avatar_library_filename.errors }}

        <!-- Avatar source radios (kept for form, visually hidden) -->
        <div class="visually-hidden">
          {{ form.avatar_source }}
        </div>

        <!-- Upload section -->
        <div id="avatarUploadSection" class="border rounded p-3 mb-2" style="display:none;">
          <div class="fw-semibold mb-2">Upload your own image</div>
          {{ form.avatar_upload }} {{ form.avatar_upload.errors }}

          {% if form.instance.avatar_source == "upload" and form.instance.avatar_upload %}
          <div class="mt-3 d-flex align-items-center">
            <img src="{{ form.instance.get_avatar_url }}"
                 alt="Current uploaded avatar"
                 class="rounded-circle me-3 border"
                 style="width:60px;height:60px;object-fit:cover;">
            <div class="text-muted small">Current uploaded avatar</div>
          </div>
          {% endif %}
        </div>

        <div class="form-text">
          Default avatars live in <code>static/images/avatars/</code>. Uploads are private to your family.
        </div>
      </div>
    </div>

    <!-- === FAVORITES === -->
    <div class="card mb-4">
      <div class="card-header fw-semibold">Favorites & Notes</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Hobbies / Sports / Interests</label>
          {{ form.hobbies_sports }}
        </div>
        <div class="mb-3">
          <label class="form-label">Favorite Stores</label>
          {{ form.favorite_stores }}
        </div>
        <div class="mb-3">
          <label class="form-label">Favorite Websites</label>
          {{ form.favorite_websites }}
        </div>
        {% if form.fields.private_notes %}
        <div class="mb-3">
          <label class="form-label">Private Notes (Parent only)</label>
          {{ form.private_notes }}
          <div class="form-text text-muted">Only visible to Parent users.</div>
        </div>
        {% endif %}
      </div>
    </div>

    <button type="submit" class="btn btn-primary w-100 mb-4">
      {% if setup_mode %}Complete Setup{% else %}Save Profile{% endif %}
    </button>
  </form>
</div>

<!-- === AVATAR PICKER MODAL (Default / Gallery / Upload) === -->
<div class="modal fade" id="avatarPickerModal" tabindex="-1" aria-labelledby="avatarPickerLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-semibold" id="avatarPickerLabel">Choose your avatar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="list-group mb-3">
          <button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between avatar-mode-btn" data-mode="default">
            <div>
              <div class="fw-semibold">Default</div>
              <div class="small text-muted">Use the system avatar</div>
            </div>
            <span class="badge bg-light text-dark border">Select</span>
          </button>

          <button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between avatar-mode-btn" data-mode="gallery">
            <div>
              <div class="fw-semibold">Gallery</div>
              <div class="small text-muted">Pick from built-in avatars</div>
            </div>
            <span class="badge bg-light text-dark border">Select</span>
          </button>

          <button type="button" class="list-group-item list-group-item-action d-flex align-items-center justify-content-between avatar-mode-btn" data-mode="upload">
            <div>
              <div class="fw-semibold">Upload</div>
              <div class="small text-muted">Upload your photo</div>
            </div>
            <span class="badge bg-light text-dark border">Select</span>
          </button>
        </div>

        <div id="gallerySection" style="display:none;">
          <p class="text-muted small mb-2">Click an avatar to select it.</p>
          <div class="row row-cols-3 row-cols-sm-4 row-cols-md-6 g-3">
            {% for filename in available_avatars %}
            <div class="col">
              <button type="button"
                      class="w-100 text-center border rounded p-2 bg-white avatar-modal-choice"
                      data-avatar-filename="{{ filename }}"
                      style="cursor:pointer;">
                <img src="{{ STATIC_URL }}images/avatars/users/{{ filename }}"
                     alt="Avatar {{ filename }}"
                     class="rounded-circle border"
                     style="width:64px;height:64px;object-fit:cover;">
              </button>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <div class="small text-muted">Selected: <span id="selectedModeLabel">Default</span></div>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- === Avatar Script (shared with setup) === -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const hiddenLibraryField = document.querySelector('input[name="avatar_library_filename"]');
  const uploadSection = document.getElementById("avatarUploadSection");
  const activeAvatarPreviewImg = document.getElementById("activeAvatarPreviewImg");
  const resetToDefaultLink = document.getElementById("resetToDefaultLink");

  const modalEl = document.getElementById("avatarPickerModal");
  const gallerySection = document.getElementById("gallerySection");
  const selectedModeLabel = document.getElementById("selectedModeLabel");

  const defaultAvatarURL = "{{ STATIC_URL }}images/avatars/default_user.png";
  const libraryRadio = document.getElementById("avatarSourceLibrary") || document.querySelector('input[name="avatar_source"][value="library"]');
  const defaultRadio = document.getElementById("avatarSourceDefault") || document.querySelector('input[name="avatar_source"][value="default"]');
  const uploadRadio  = document.getElementById("avatarSourceUpload")  || document.querySelector('input[name="avatar_source"][value="upload"]');

  // NEW: get the Bootstrap modal instance safely
  function getModalInstance() {
    if (!window.bootstrap || !modalEl) return null;
    return bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
  }

  function setMode(mode) {
    if (mode === "default" && defaultRadio) {
      defaultRadio.checked = true;
      if (hiddenLibraryField) hiddenLibraryField.value = "";
      if (gallerySection) gallerySection.style.display = "none";
      if (activeAvatarPreviewImg) activeAvatarPreviewImg.src = defaultAvatarURL;
      if (uploadSection) uploadSection.style.display = "none";
      if (selectedModeLabel) selectedModeLabel.textContent = "Default";
    }

    if (mode === "gallery" && libraryRadio) {
      libraryRadio.checked = true;
      if (gallerySection) gallerySection.style.display = "block";
      if (uploadSection) uploadSection.style.display = "none";
      if (selectedModeLabel) selectedModeLabel.textContent = "Gallery";
    }

    if (mode === "upload" && uploadRadio) {
      uploadRadio.checked = true;
      if (gallerySection) gallerySection.style.display = "none";
      if (uploadSection) uploadSection.style.display = "block";
      if (selectedModeLabel) selectedModeLabel.textContent = "Upload";

      // NEW: close the picker immediately so the file input is usable
      const inst = getModalInstance();
      if (inst) inst.hide();

      // Optional: focus the file input after the modal closes
      setTimeout(() => {
        const fileInput = document.querySelector('input[type="file"][name="avatar_upload"]');
        if (fileInput) fileInput.focus();
      }, 150);
    }
  }

  if (modalEl) {
    modalEl.addEventListener("click", function (e) {
      const modeBtn = e.target.closest(".avatar-mode-btn");
      if (modeBtn) {
        setMode(modeBtn.getAttribute("data-mode"));
        return;
      }

      // Gallery avatar pick
      const pick = e.target.closest(".avatar-modal-choice");
      if (pick) {
        const filename = pick.getAttribute("data-avatar-filename");
        if (!filename) return;

        if (hiddenLibraryField) hiddenLibraryField.value = filename;
        const url = "{{ STATIC_URL }}images/avatars/users/" + filename;
        if (activeAvatarPreviewImg) activeAvatarPreviewImg.src = url;

        if (libraryRadio) libraryRadio.checked = true;
        if (selectedModeLabel) selectedModeLabel.textContent = "Gallery";
      }
    });
  }

  if (resetToDefaultLink) {
    resetToDefaultLink.addEventListener("click", function (e) {
      e.preventDefault();
      setMode("default");
    });
  }

  (function init() {
    const selected = document.querySelector('input[name="avatar_source"]:checked');
    setMode(selected ? selected.value : "default");
  })();
});
</script>

{% endblock %}
