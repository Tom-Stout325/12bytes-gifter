{% extends "index.html" %}
{% load static %}

{% block title %}
  {{ target_user.first_name }} {{ target_user.last_name }} | Gifter
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 700px">

  <!-- Profile Card -->
  <div class="card mb-4">
    <div class="card-body d-flex flex-column flex-sm-row align-items-start gap-3">

      <!-- Avatar -->
      <div
        style="
          width: 80px;
          height: 80px;
          border-radius: 50%;
          overflow: hidden;
          background-color: #eee;">
        <img
          src="{{ target_profile.get_avatar_url }}"
          alt="{{ target_user.first_name }}'s avatar"
          style="width: 100%; height: 100%; object-fit: cover;" />
      </div>

      <!-- Basic info -->
      <div class="flex-grow-1">
        <h2 class="h4 text-secondary mb-1 d-flex flex-wrap align-items-center gap-2">
          <span>
            {{ target_user.first_name }} {{ target_user.last_name }}
          </span>
          {% if viewer_profile.role == "Parent" %}
            {% if target_profile.role and target_profile.role != "Child" %}
              <span class="badge bg-secondary">{{ target_profile.role }}</span>
            {% endif %}
          {% endif %}
        </h2>

        <div class="text-muted small">
          {% if target_profile.birthday %}
            <div><strong>Birthday:</strong> {{ target_profile.birthday }}</div>
          {% endif %}
          {% if target_profile.anniversary %}
            <div><strong>Anniversary:</strong> {{ target_profile.anniversary }}</div>
          {% endif %}
        </div>

        {% if can_view_private_notes and target_profile.private_notes %}
          <div class="mt-3 p-2 rounded bg-soft">
            <div class="small text-secondary fw-bold mb-1">
              Private Notes (Parents Only)
            </div>
            <div class="small">
              {{ target_profile.private_notes|linebreaksbr }}
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Gift Info -->
  <div class="card mb-4">
    <div class="card-header">Gift Info</div>
    <div class="card-body small">
      <div class="row">
        <div class="col-6 mb-2">
          <strong>Shirt Size:</strong>
          {{ target_profile.shirt_size|default:"—" }}
        </div>
        <div class="col-6 mb-2">
          <strong>Pants Size:</strong>
          {{ target_profile.pants_size|default:"—" }}
        </div>
        <div class="col-6 mb-2">
          <strong>Shoe Size:</strong>
          {{ target_profile.shoe_size|default:"—" }}
        </div>
      </div>

      {% if target_profile.hobbies_sports %}
        <div class="mb-2">
          <strong>Hobbies / Sports:</strong><br />
          {{ target_profile.hobbies_sports|linebreaksbr }}
        </div>
      {% endif %}

      {% if target_profile.favorite_stores %}
        <div class="mb-2">
          <strong>Favorite Stores:</strong><br />
          {{ target_profile.favorite_stores|linebreaksbr }}
        </div>
      {% endif %}

      {% if target_profile.favorite_websites %}
        <div class="mb-2">
          <strong>Favorite Websites:</strong><br />
          {{ target_profile.favorite_websites|linebreaksbr }}
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Wishlist -->
  <div class="card mb-5">

    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
      <span>Wishlist</span>

      {% if can_edit_wishlist %}
        <a
          href="{% url 'gifter:add_wishlist_item' username=target_user.username %}"
          class="btn btn-sm btn-emphasis"
          style="white-space: nowrap;">
          <i class="fa-solid fa-plus me-1"></i>
          Add Item
        </a>
      {% endif %}
    </div>

    <div class="card-body small">
      {% if wishlist_items %}
        <ul class="list-group list-group-flush">
          {% for item in wishlist_items %}
            <li class="list-group-item">
              <div class="d-flex flex-column flex-sm-row align-items-start gap-3 w-100">

                {# Item image preview (optional per-item image) #}
                {% if item.image %}
                  <div
                    style="
                      width: 70px;
                      height: 70px;
                      border-radius: 0.5rem;
                      overflow: hidden;
                      background: #f5f5f5;
                      flex-shrink: 0;">
                    <img
                      src="{{ item.image.url }}"
                      alt="{{ item.title }}"
                      style="width: 100%; height: 100%; object-fit: cover;" />
                  </div>
                {% endif %}

                <div class="flex-grow-1 w-100">
                  <!-- Title / price row -->
                  <div class="d-flex justify-content-between flex-wrap">
                    <div class="fw-semibold text-secondary">{{ item.title }}</div>

                    {% if item.price_estimate %}
                      <div class="text-muted">
                        ${{ item.price_estimate }}
                      </div>
                    {% endif %}
                  </div>

                  {% if item.description %}
                    <div class="text-muted">
                      {{ item.description }}
                    </div>
                  {% endif %}

                  {% if item.link %}
                    <div class="mt-1">
                      <a
                        href="{{ item.link }}"
                        target="_blank"
                        rel="noopener"
                        class="text-primary">
                        View / Buy
                        <i class="fa-solid fa-arrow-up-right-from-square ms-1"></i>
                      </a>
                    </div>
                  {% endif %}

                  {# Claim / purchase badges (visibility controlled by can_view_purchase_info) #}
                  {% if can_view_purchase_info %}
                    <div class="mt-2 d-flex flex-wrap gap-2">
                      {% if item.is_claimed and item.claimed_by %}
                        <span class="badge bg-emphasis text-dark fw-semibold">
                          Claimed
                          {% if item.claimed_by.user %}
                            by {{ item.claimed_by.user.first_name }} {{ item.claimed_by.user.last_name }}
                          {% endif %}
                        </span>
                      {% endif %}

                      {% if item.is_purchased and item.purchased_by %}
                        <span class="badge bg-success text-dark fw-semibold">
                          Purchased
                          {% if item.purchased_by.user %}
                            by {{ item.purchased_by.user.first_name }} {{ item.purchased_by.user.last_name }}
                          {% endif %}
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}

                  {# Claim / purchase action buttons (only shown if viewer is allowed to see purchase info) #}
                  {% if can_view_purchase_info %}
                    <div class="mt-3 d-flex flex-wrap gap-2">

                      {# Claim / Unclaim logic #}
                      {% if item.is_claimed and item.claimed_by and item.claimed_by.user == request.user %}
                        <form
                          action="{% url 'gifter:unclaim_wishlist_item' pk=item.pk %}"
                          method="post"
                          class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-secondary">
                            <i class="fa-solid fa-rotate-left me-1"></i> Unclaim
                          </button>
                        </form>

                      {% elif not item.is_claimed %}
                        <form
                          action="{% url 'gifter:claim_wishlist_item' pk=item.pk %}"
                          method="post"
                          class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-secondary">
                            <i class="fa-solid fa-hand-holding-heart me-1"></i> Claim
                          </button>
                        </form>

                      {% else %}
                        <button class="btn btn-sm btn-secondary" disabled>
                          <i class="fa-solid fa-hand-holding-heart me-1"></i> Claimed
                        </button>
                      {% endif %}

                      {# Purchase / Unpurchase logic #}
                      {% if item.is_purchased %}
                        <form
                          action="{% url 'gifter:clear_purchased_wishlist_item' pk=item.pk %}"
                          method="post"
                          class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-danger">
                            <i class="fa-solid fa-xmark me-1"></i> Undo Purchased
                          </button>
                        </form>
                      {% else %}
                        <form
                          action="{% url 'gifter:mark_purchased_wishlist_item' pk=item.pk %}"
                          method="post"
                          class="d-inline">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-primary">
                            <i class="fa-solid fa-check me-1"></i> Mark Purchased
                          </button>
                        </form>
                      {% endif %}
                    </div>
                  {% endif %}

                  {# Owner / allowed parent edit/delete for wishlist item #}
                  {% if can_edit_wishlist %}
                    <div class="mt-3 d-flex flex-wrap gap-2">
                      <a
                        href="{% url 'gifter:edit_wishlist_item' pk=item.pk %}"
                        class="btn btn-sm btn-secondary">
                        <i class="fa-solid fa-pen-to-square me-1"></i> Edit
                      </a>
                      <a
                        href="{% url 'gifter:delete_wishlist_item' pk=item.pk %}"
                        class="btn btn-sm btn-danger">
                        <i class="fa-solid fa-trash-can me-1"></i> Delete
                      </a>
                    </div>
                  {% endif %}

                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No items yet.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
