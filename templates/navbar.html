{% load static %}
{% with p=user_profile %}

<nav class="navbar navbar-expand-lg navbar-dark" style="background-color: var(--color-secondary)">
  <div class="container-fluid">
    <!-- Brand -->
    <a class="navbar-brand d-flex align-items-center fw-semibold" href="{% url 'root' %}">
      <img
        src="{% static 'images/logo.png' %}"
        alt="Gifter Logo"
        class="me-2"
        style="height: 36px; width: auto"
        id="navbar-logo"
      />
      Gifter
    </a>

    <!-- Mobile Toggle Button -->
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#mainNav"
      aria-controls="mainNav"
      aria-expanded="false"
      aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Collapsible Content -->
    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

        <!-- Help is always visible -->
        <li class="nav-item">
          <a
            class="nav-link {% if request.resolver_match and request.resolver_match.url_name == 'help' %}active{% endif %}"
            href="{% url 'accounts:help' %}">
            <i class="fa-regular fa-circle-question me-1"></i>&nbsp;Help&nbsp;&nbsp;&nbsp;
          </a>
        </li>

        {# ================== GUEST NAV ================== #}
        {% if not request.user.is_authenticated %}
          <!-- Guest links -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:login' %}">
              <i class="fa-solid fa-right-to-bracket me-1"></i> Login
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:register' %}">
              <i class="fa-solid fa-user-plus me-1"></i> Register
            </a>
          </li>

        {# ================== AUTHENTICATED NAV ================== #}
        {% else %}

          {# If there is no Profile yet, push to setup/logout #}
          {% if not p %}
            <li class="nav-item">
              <a class="nav-link" href="{% url 'accounts:profile_setup' %}">
                <i class="fa-solid fa-pen-to-square me-1"></i> Complete Profile
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{% url 'accounts:logout' %}">
                <i class="fa-solid fa-right-from-bracket me-1"></i> Logout
              </a>
            </li>

          {% else %}

            {% with name=request.resolver_match.url_name %}

              {# ========== APPROVED USERS ========== #}
              {% if p.is_approved %}

                <!-- All Families -->
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'all_families' or name == 'family_detail' %}active{% endif %}"
                    href="{% url 'gifter:all_families' %}">
                    <i class="fa-solid fa-people-roof me-1"></i> All Families
                  </a>
                </li>

                <!-- My Family (if user belongs to one) -->
                {% if p.family %}
                  <li class="nav-item">
                    <a
                      class="nav-link {% if name == 'family_detail' and request.resolver_match.kwargs.slug == p.family.slug %}active{% endif %}"
                      href="{% url 'gifter:family_detail' slug=p.family.slug %}">
                      <i class="fa-solid fa-house-user me-1"></i>
                      My Family
                    </a>
                  </li>
                {% endif %}

                <!-- My Profile -->
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'profile_detail' %}active{% endif %}"
                    href="{% url 'accounts:profile_detail' username=request.user.username %}">
                    <i class="fa-solid fa-user me-1"></i> My Profile
                  </a>
                </li>

                <!-- Calendar -->
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'calendar_current' or name == 'calendar_month' %}active{% endif %}"
                    href="{% url 'gifter:calendar_current' %}">
                    <i class="fa-regular fa-calendar me-1"></i> Calendar
                  </a>
                </li>

                <!-- Message Board -->
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'board_list' or name == 'board_detail' or name == 'board_create' or name == 'board_update' %}active{% endif %}"
                    href="{% url 'gifter:board_list' %}">
                    <i class="fa-regular fa-message me-1"></i> Message Board
                  </a>
                </li>

              {# ========== PENDING APPROVAL ========== #}
              {% else %}
                <!-- Pending approval view -->
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'pending_approval' %}active{% endif %}"
                    href="{% url 'accounts:pending_approval' %}">
                    <i class="fa-solid fa-clock me-1"></i> Pending Approval
                  </a>
                </li>
                <li class="nav-item">
                  <a
                    class="nav-link {% if name == 'profile_setup' %}active{% endif %}"
                    href="{% url 'accounts:profile_setup' %}">
                    <i class="fa-solid fa-pen-to-square me-1"></i> Complete Profile
                  </a>
                </li>
              {% endif %}

            {% endwith %}

            <!-- Role badge / identity summary -->
            <li class="nav-item d-flex align-items-center ms-lg-3 mt-2 mt-lg-0">
              <span
                class="badge bg-emphasis text-dark fw-semibold"
                style="font-size: 0.8rem">
                {{ request.user.first_name }}
                {% if request.user.last_name %}
                  {{ request.user.last_name }}
                {% endif %}
                {% if p.role == "Parent" %}
                  Â· {{ p.role }}
                {% endif %}
              </span>
            </li>

            <!-- Logout -->
            <li class="nav-item ms-lg-3">
              <a class="nav-link" href="{% url 'accounts:logout' %}">
                <i class="fa-solid fa-right-from-bracket me-1"></i> Logout
              </a>
            </li>

          {% endif %} {# end if p #}

        {% endif %} {# end if authenticated #}

        <!-- Theme Toggle -->
        <li class="nav-item ms-lg-3 my-2 my-lg-0">
          <button
            id="theme-toggle"
            class="btn btn-sm btn-outline-light d-flex align-items-center justify-content-center"
            type="button"
            aria-label="Toggle theme"
            style="min-width: 2rem; min-height: 2rem; line-height: 1">
            <i
              id="theme-icon"
              class="fa-solid fa-moon"
              style="font-size: 0.9rem; line-height: 1">
            </i>
          </button>
        </li>

      </ul>
    </div>
  </div>
</nav>
{% endwith %}
